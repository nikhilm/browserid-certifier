<!DOCTYPE html>
<head>
    <script src="https://login.persona.org/provisioning_api.js" language="javascript" type="text/javascript"></script>

    <script src="../js/strophe.min.js" language="javascript" type="text/javascript"></script>
    <script src="../js/strophe.rpc.js" language="javascript" type="text/javascript"></script>
    <script language="javascript" type="text/javascript">
      var BOSH_SERVICE = 'https://nikhilism.com/http-bind/';
      var connection = null;
      navigator.id.beginProvisioning(function(jid, certDuration) {
        if (sessionStorage.getItem("jid") !== jid)
          navigator.id.raiseProvisioningFailure("JID not authenticated");

        navigator.id.genKeyPair(function(publicKey) {
          connection = new Strophe.Connection(BOSH_SERVICE);
          connection.attach(
            sessionStorage.getItem("jid"),
            sessionStorage.getItem("sid"),
            parseInt(sessionStorage.getItem("rid")) + 1,
            function(status, error) {
            console.log(status, error);
              if (status == Strophe.Status.CONNECTING) {
              } else if (status == Strophe.Status.AUTHENTICATING) {
              } else if (status == Strophe.Status.ATTACHED) {
                console.log("Begin XML-RPC");
                connection.rpc.addResponseHandler(responseHandler);
                connection.rpc.sendRequest(parseInt(Math.random()*1000000) + 1, 'persona.nikhilism.com', 'getSignedCertificate', [ connection.jid, publicKey, certDuration ]);
              } else {
                console.log("Failure!", arguments);
              }
            });
        });
      });

      function responseHandler(id, from, result, error) {
          console.log("RPC response");
        if (error === true) {
          navigator.id.raiseProvisioningFailure("XML-RPC response error");
          return;
        }

        console.log("Response", arguments);
        navigator.id.registerCertificate(result);
      }
    </script>
</head>
<body>
</body>
</html>
